# WHO-SAID-WHAT PROJECT - FORMATS, TYPES, SYSTEMS & CONNECTIONS

This document comprehensively covers all data formats, file types, communication protocols, technical stacks, connection methods, class structures, and data exchange formats used in the Who-Said-What project.

---

## 1. DATA FORMATS & FILE TYPES

### 1.1 INPUT DATA FORMATS

#### Markdown (.md)
- **Purpose**: Primary content import format
- **Frontmatter**: YAML format (gray-matter parser)
- **Body**: CommonMark specification
- **Parser**: gray-matter 4.0.3
- **Use cases**: Case imports, documentation

#### CSV (.csv)
- **Delimiter**: Comma (,)
- **Encoding**: UTF-8
- **Quote character**: Double quotes (")
- **Escape character**: Backslash (\)
- **Parser**: csv-parse 6.1.0
- **Headers**: Required in first row
- **Use cases**: Bulk person/organization imports

#### JSON (.json)
- **Standard**: RFC 8259 (ECMA-404)
- **Encoding**: UTF-8
- **Parser**: Native JSON.parse with jsonrepair 3.13.1 fallback
- **Use cases**: API payloads, configuration, metadata

#### Form Data (multipart/form-data)
- **Parser**: formidable 3.5.4
- **Max file size**: Configurable
- **Fields**: File uploads + metadata
- **Use cases**: Image uploads, document uploads

### 1.2 OUTPUT DATA FORMATS

#### JSON (application/json)
- **Standard response structure**:
```json
{
  "success": true|false,
  "data": object|array|null,
  "error": string|null,
  "meta": {
    "total": number,
    "page": number,
    "limit": number,
    "hasMore": boolean
  }
}
```

#### XML (application/xml)
- **Sitemaps**: XML Sitemap protocol 0.9
- **RSS**: RSS 2.0 (potential future use)
- **Format**: Well-formed XML with UTF-8 encoding

#### CSV (text/csv)
- **Export format**: Bulk data exports
- **Excel-compatible**: UTF-8 with BOM
- **Line endings**: CRLF for Windows compatibility

#### HTML (text/html)
- **Version**: HTML5
- **Rendering**: Server-side (Next.js)
- **Semantic markup**: article, section, nav, aside, header, footer

### 1.3 IMAGE FORMATS

#### Input Formats
- JPEG (.jpg, .jpeg) - Lossy compression for photos
- PNG (.png) - Lossless, supports transparency
- WebP (.webp) - Modern web format
- AVIF (.avif) - Next-generation format
- SVG (.svg) - Vector graphics, XML-based
- GIF (.gif) - Animated images, limited color palette

#### Output Formats (Optimized)
1. **AVIF** (primary) - Best compression
2. **WebP** (fallback) - Wide browser support
3. **Original format** (final fallback)

#### Image Sizes
- Device sizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840]
- Image sizes: [16, 32, 48, 64, 96, 128, 256, 384]

### 1.4 DOCUMENT FORMATS

#### PDF (.pdf)
- **Use cases**: Source archival, citation snapshots, exports
- **Generation**: Server-side (potential)
- **Reading**: Future feature

#### Plain Text (.txt)
- **Use cases**: Log files, simple data exports
- **Encoding**: UTF-8

### 1.5 CONFIGURATION FORMATS

#### JSON Configuration
- **package.json** - npm/Node.js configuration
- **tsconfig.json** - TypeScript compiler options
- **vercel.json** - Vercel deployment config
- **manifest.json** - PWA manifest

#### JavaScript Configuration
- **next.config.js** - Next.js configuration
- **tailwind.config.js** - Tailwind CSS setup

#### Environment Variables (.env)
- **Format**: KEY=VALUE
- **Comments**: # prefix
- **No quotes**: Values don't need quotes
- **Files**: .env, .env.local, .env.production, .env.development

### 1.6 DATABASE FORMATS

#### Prisma Schema (.prisma)
- **Language**: Prisma Schema Language (DSL)
- **Location**: prisma/schema.prisma
- **Sections**: generator, datasource, models, enums

#### SQL Migrations (.sql)
- **Generated by**: Prisma Migrate
- **Location**: prisma/migrations/[timestamp]_[name]/
- **Format**: Standard SQL DDL/DML

### 1.7 STYLESHEET FORMATS

#### CSS (.css)
- **Standard**: CSS3
- **Modules**: *.module.css (scoped)
- **Global**: styles/globals.css

#### styled-jsx
- **Syntax**: CSS-in-JS embedded in components
- **Scope**: Component-scoped by default
- **Format**: `<style jsx>{`...`}</style>`

---

## 2. DATA EXCHANGE FORMATS & PROTOCOLS

### 2.1 HTTP REQUEST/RESPONSE FORMATS

#### HTTP Methods
- **GET** - Retrieve resources (idempotent, cacheable)
- **POST** - Create resources (non-idempotent)
- **PUT** - Full resource update (idempotent)
- **PATCH** - Partial update (idempotent)
- **DELETE** - Remove resources (idempotent)
- **OPTIONS** - CORS preflight
- **HEAD** - Headers only (no body)

#### Request Content-Type Headers
- `application/json` - JSON payloads (primary)
- `application/x-www-form-urlencoded` - Form submissions
- `multipart/form-data` - File uploads
- `text/plain` - Plain text
- `application/xml` - XML data

#### Response Content-Type Headers
- `application/json` - API responses
- `text/html` - HTML pages
- `text/xml` - XML sitemaps
- `text/csv` - CSV exports
- `image/*` - Image responses

#### Accept Headers
- `application/json` - Request JSON
- `text/html` - Request HTML
- `*/*` - Accept any format

### 2.2 API RESPONSE STRUCTURES

#### Success Response
```typescript
{
  success: true,
  data: {
    // Resource data (object or array)
  },
  meta?: {
    total?: number,
    page?: number,
    limit?: number,
    hasMore?: boolean,
    hasPrev?: boolean
  }
}
```

#### Error Response
```typescript
{
  success: false,
  error: "Error message",
  code?: "ERROR_CODE",
  details?: {
    field: "error detail"
  },
  stack?: "..." // Development only
}
```

#### Paginated Response
```typescript
{
  success: true,
  data: [...],
  meta: {
    total: 100,
    page: 1,
    limit: 20,
    totalPages: 5,
    hasMore: true,
    hasPrev: false
  }
}
```

### 2.3 WEBHOOK FORMATS

#### Outgoing Webhook Payload
```json
{
  "event": "case.created",
  "id": "evt_...",
  "timestamp": "2025-01-26T12:00:00Z",
  "data": {
    "id": "case_id",
    "type": "Case",
    "action": "created",
    "before": null,
    "after": { /* case data */ }
  },
  "metadata": {
    "userId": "...",
    "source": "admin_panel"
  }
}
```

#### Webhook Headers
```
Content-Type: application/json
X-Webhook-Signature: sha256=abc123...
X-Webhook-ID: webhook_abc123
X-Webhook-Timestamp: 2025-01-26T12:00:00Z
User-Agent: WSW-Webhook/1.0
```

---

## 3. COMMUNICATION PROTOCOLS & METHODS

### 3.1 CLIENT-SERVER PROTOCOLS

#### HTTP/HTTPS
- **Version**: HTTP/1.1 and HTTP/2
- **Encryption**: TLS 1.2+ (minimum)
- **Port**: 443 (HTTPS production), 3000 (local dev)
- **Headers**: Standard + custom security headers

#### WebSocket (Future)
- **Protocol**: ws:// (dev), wss:// (production)
- **Standard**: RFC 6455
- **Use case**: Real-time updates, live notifications
- **Status**: Not currently implemented

### 3.2 DATABASE CONNECTION PROTOCOLS

#### PostgreSQL Protocol
- **Wire Protocol**: PostgreSQL native binary protocol
- **Port**: 5432 (default)
- **SSL Mode**: require (enforced)
- **Connection String Format**:
```
postgresql://USER:PASSWORD@HOST:PORT/DATABASE?sslmode=require
```

#### Connection Types

**Session Pooling (DATABASE_URL)**:
- Purpose: Application queries
- Pooling: Managed by Supabase
- Concurrency: Multiple connections

**Direct Connection (DIRECT_URL)**:
- Purpose: Migrations, schema changes
- Pooling: None
- Concurrency: Single connection

#### Supabase Connection Details
- **Host**: db.sboopxosgongujqkpbxo.supabase.co
- **Port**: 5432
- **Database**: postgres
- **Schema**: public (default)
- **SSL**: Required

### 3.3 EXTERNAL API PROTOCOLS

#### Anthropic Claude API
- **Protocol**: HTTPS
- **Method**: POST
- **Base URL**: https://api.anthropic.com/v1
- **Endpoint**: /messages
- **Authentication**: Header-based (`x-api-key`)
- **Content-Type**: application/json
- **Rate Limiting**: Per API key

#### Tavily Search API
- **Protocol**: HTTPS
- **Method**: POST
- **Authentication**: API key in body
- **Format**: JSON request/response
- **Rate Limiting**: Based on plan

#### Firecrawl API
- **Protocol**: HTTPS
- **Method**: POST
- **Authentication**: Header-based API key
- **Format**: JSON with URL + options
- **Response**: Markdown/HTML/Links

#### Supabase REST API
- **Protocol**: HTTPS over PostgREST
- **Authentication**: API key + JWT
- **Auto-generated**: From database schema
- **Query format**: URL-based filters

---

## 4. TECHNICAL STACKS & ARCHITECTURE LAYERS

### 4.1 FULL STACK ARCHITECTURE DIAGRAM

```
┌─────────────────────────────────────────────┐
│         CLIENT LAYER (Browser)              │
│  - React Components (TSX)                   │
│  - State Management (Zustand)               │
│  - Styling (Tailwind + styled-jsx)          │
│  - Client-side routing                      │
└─────────────────────────────────────────────┘
              ↕ HTTP/HTTPS (fetch API)
┌─────────────────────────────────────────────┐
│    PRESENTATION LAYER (Next.js SSR)         │
│  - Server-Side Rendering                    │
│  - Static Site Generation                   │
│  - API Route handlers                       │
│  - Middleware (auth, CORS)                  │
└─────────────────────────────────────────────┘
              ↕ Function Calls
┌─────────────────────────────────────────────┐
│      APPLICATION LAYER (Business Logic)     │
│  - lib/ modules                             │
│  - Services (case-lifecycle, archive, etc)  │
│  - Utilities and helpers                    │
│  - Validation logic                         │
└─────────────────────────────────────────────┘
              ↕ Prisma Client (Type-safe)
┌─────────────────────────────────────────────┐
│       DATA ACCESS LAYER (Prisma ORM)        │
│  - Generated Prisma Client                  │
│  - Query builder                            │
│  - Relation loading                         │
│  - Type safety                              │
└─────────────────────────────────────────────┘
              ↕ PostgreSQL Wire Protocol
┌─────────────────────────────────────────────┐
│      DATABASE LAYER (PostgreSQL)            │
│  - Tables & Relations                       │
│  - Indexes (B-tree, GIN, trigram)           │
│  - Extensions (pg_trgm, uuid-ossp)          │
│  - Constraints & Triggers                   │
└─────────────────────────────────────────────┘
```

### 4.2 FRONTEND TECHNOLOGY STACK

#### Component Layer
- **React**: 18.0.0 - UI library
- **TypeScript**: 5.9.3 - Type system
- **JSX/TSX**: Component syntax

#### Styling Stack
- **Tailwind CSS**: 3.x - Utility-first framework
- **styled-jsx**: Next.js built-in - Scoped CSS
- **CSS Modules**: *.module.css - Component styles

#### State Management
- **React Hooks**: useState, useEffect, useContext
- **Zustand**: 5.0.8 - Lightweight global state
- **Component State**: Local component state

#### Routing & Navigation
- **Next.js Pages Router**: File-based routing
- **Dynamic Routes**: [slug], [id] parameters
- **Link Component**: Client-side navigation

#### Data Fetching
- **fetch API**: Native browser API
- **SWR Pattern**: Stale-while-revalidate
- **getServerSideProps**: Server-side data
- **getStaticProps**: Static generation

#### UI Components
- **Custom Components**: components/
- **Form Handling**: React controlled components
- **Error Boundaries**: Error handling

### 4.3 BACKEND TECHNOLOGY STACK

#### API Layer
- **Next.js API Routes**: Serverless functions
- **TypeScript**: Type-safe handlers
- **Middleware**: Authentication, validation

#### Business Logic
- **Services**: lib/ directory
- **Utilities**: Helper functions
- **Validators**: Input validation
- **Mappers**: Data transformation

#### Data Access Layer
- **Prisma Client**: Generated ORM client
- **Type Safety**: Full TypeScript support
- **Query Building**: Fluent API
- **Relations**: Eager/lazy loading

#### Database Layer
- **PostgreSQL**: 15+ version
- **Extensions**:
  - pg_trgm - Full-text search
  - btree_gin - Composite indexes
  - uuid-ossp - UUID generation
- **Features**: JSONB, arrays, full-text search

### 4.4 AUTHENTICATION & SECURITY STACK

#### Token Management
- **jsonwebtoken**: 9.0.2 - JWT creation/verification
- **Algorithm**: RS256 (RSA) or HS256 (HMAC)
- **Token Types**: Access (15m) + Refresh (7d)

#### Password Security
- **bcryptjs**: 3.0.2 - Password hashing
- **Salt Rounds**: 10
- **Secure Comparison**: Timing-safe comparison

#### Session Management
- **Storage**: Database-backed (Session model)
- **Delivery**: HTTP-only cookies
- **Features**: Rotation, revocation, expiration

#### Authorization
- **Role-Based**: UserRole enum (12 roles)
- **Permission Arrays**: Granular permissions
- **Group System**: Group/UserGroup models

---

## 5. CLASS STRUCTURES & TYPE SYSTEMS

### 5.1 TYPESCRIPT TYPE HIERARCHIES

#### Prisma-Generated Base Types
```typescript
// Auto-generated from schema
interface Person {
  id: string;              // CUID
  slug: string;
  name: string;
  profession?: ProfessionType;
  // ... 100+ fields
}

interface Organization {
  id: string;
  slug: string;
  name: string;
  type: OrganizationType;
  orgType?: OrgType;
  // ... 50+ fields
}

interface Case {
  id: string;
  slug: string;
  title: string;
  status: CaseStatus;
  severity?: CaseSeverity;
  // ... 70+ fields
}
```

#### Extended Relation Types
```typescript
// With included relations
type PersonWithAffiliations = Person & {
  affiliations: Affiliation[];
  statements: Statement[];
  nationalities: PersonNationality[];
}

type CaseWithDetails = Case & {
  statements: Statement[];
  repercussions: Repercussion[];
  sources: Source[];
  tags: Tag[];
}
```

#### Enum Types
```typescript
// 170+ enums total
enum UserRole {
  ADMIN = "ADMIN",
  DE = "DE",
  DBO = "DBO",
  // ... 9 more
}

enum CaseStatus {
  DOCUMENTED = "DOCUMENTED",
  VERIFIED = "VERIFIED",
  DISPUTED = "DISPUTED",
  // ... 9 more
}

enum Medium {
  TELEVISION_INTERVIEW = "TELEVISION_INTERVIEW",
  TWITTER_X = "TWITTER_X",
  FACEBOOK = "FACEBOOK",
  // ... 40+ more
}
```

### 5.2 API TYPE STRUCTURES

#### Request Types
```typescript
// Query Parameters
interface PaginationParams {
  page?: number;           // Default: 1
  limit?: number;          // Default: 20, Max: 100
  sortBy?: string;         // Field name
  sortOrder?: 'asc' | 'desc';
}

interface FilterParams {
  status?: CaseStatus[];
  severity?: CaseSeverity[];
  dateFrom?: string;       // ISO 8601
  dateTo?: string;         // ISO 8601
  search?: string;
}

// Request Bodies
interface CreateCaseRequest {
  title: string;
  summary: string;
  description: string;
  caseDate: string;        // ISO 8601
  severity?: CaseSeverity;
  locationCity?: string;
  // ...
}

interface UpdateCaseRequest {
  title?: string;
  summary?: string;
  status?: CaseStatus;
  // ... all fields optional
}
```

#### Response Types
```typescript
interface ApiResponse<T> {
  success: boolean;
  data: T | null;
  error?: string;
  code?: string;
  meta?: PaginationMeta;
}

interface PaginationMeta {
  total: number;
  page: number;
  limit: number;
  totalPages: number;
  hasMore: boolean;
  hasPrev: boolean;
}

interface ApiError {
  success: false;
  error: string;
  code?: ErrorCode;
  details?: Record<string, any>;
}
```

### 5.3 FORM DATA STRUCTURES

#### Dynamic Form System
```typescript
type FieldType =
  | 'text'
  | 'textarea'
  | 'number'
  | 'date'
  | 'datetime'
  | 'select'
  | 'multiselect'
  | 'checkbox'
  | 'radio'
  | 'array'
  | 'json';

interface FormField {
  name: string;
  label: string;
  type: FieldType;
  required?: boolean;
  defaultValue?: any;
  options?: Array<{
    value: string;
    label: string;
  }>;
  validation?: ValidationRule[];
  helpText?: string;
  placeholder?: string;
}

interface FormSection {
  title: string;
  description?: string;
  fields: FormField[];
  collapsible?: boolean;
  defaultOpen?: boolean;
}
```

### 5.4 JSON SCHEMA TYPES

#### Metadata Structures
```typescript
// User preferences (JSON field)
interface UserPreferences {
  theme?: 'light' | 'dark' | 'auto';
  language?: string;
  timezone?: string;
  notifications?: {
    email?: boolean;
    inApp?: boolean;
    digest?: 'daily' | 'weekly' | 'never';
  };
  dashboard?: {
    layout?: 'grid' | 'list';
    widgets?: string[];
  };
}

// Case metadata
interface CaseMetadata {
  importSource?: string;
  enrichmentVersion?: string;
  qualityScore?: number;
  lastAIAnalysis?: string;
  researchNotes?: string[];
  customFields?: Record<string, any>;
}

// Automation trigger config
interface AutomationTrigger {
  type: 'schedule' | 'event' | 'webhook';
  config: {
    cron?: string;
    eventType?: string;
    webhookUrl?: string;
  };
}
```

---

## 6. DATA VALIDATION & TRANSFORMATION

### 6.1 VALIDATION PATTERNS

#### Field Validation Rules
```typescript
interface ValidationRule {
  type: 'required' | 'minLength' | 'maxLength' | 'pattern' | 'email' | 'url' | 'custom';
  value?: any;
  message: string;
}

// Example validation config
const PersonValidation = {
  slug: {
    required: true,
    pattern: /^[a-z0-9-]+$/,
    minLength: 2,
    maxLength: 200
  },
  name: {
    required: true,
    minLength: 2,
    maxLength: 200
  },
  email: {
    pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/
  }
};
```

### 6.2 DATA TRANSFORMATION PATTERNS

#### Mapper Interfaces
```typescript
// Source to Citation
interface SourceMapper {
  toHarvardStyle(source: Source): HarvardCitation;
  toAPA(source: Source): APACitation;
  toChicago(source: Source): ChicagoCitation;
  toBibTeX(source: Source): BibTeXEntry;
}

// Entity to View Model
interface PersonMapper {
  toCardView(person: Person): PersonCard;
  toDetailView(person: PersonWithRelations): PersonDetail;
  toListItem(person: Person): PersonListItem;
  toSearchResult(person: Person): SearchResult;
}

// Import to Database
interface ImportMapper {
  csvToPerson(row: CsvRow): PersonCreateInput;
  markdownToCase(md: MarkdownFile): CaseCreateInput;
  jsonToStatement(json: any): StatementCreateInput;
}
```

### 6.3 SERIALIZATION FORMATS

#### Date/Time Serialization
- **Database**: PostgreSQL TIMESTAMPTZ
- **Prisma**: JavaScript Date object
- **API**: ISO 8601 string
- **Display**: Localized string (date-fns)

#### Enum Serialization
- **Database**: PostgreSQL ENUM type
- **Prisma**: TypeScript string literal union
- **API**: String value
- **Display**: Human-readable label

#### JSON Field Serialization
- **Database**: PostgreSQL JSONB (binary)
- **Prisma**: Prisma.JsonValue
- **API**: Serialized JSON object
- **Display**: Parsed and formatted

---

## 7. EXTERNAL INTEGRATION FORMATS

### 7.1 ANTHROPIC CLAUDE API

#### Request Format
```typescript
interface ClaudeRequest {
  model: "claude-3-5-sonnet-20241022";
  max_tokens: number;      // 1024-4096
  messages: Array<{
    role: 'user' | 'assistant';
    content: string | ContentBlock[];
  }>;
  system?: string;         // System prompt
  temperature?: number;    // 0.0-1.0
  top_p?: number;         // 0.0-1.0
  stop_sequences?: string[];
  metadata?: {
    user_id?: string;
  };
}
```

#### Response Format
```typescript
interface ClaudeResponse {
  id: string;
  type: 'message';
  role: 'assistant';
  content: Array<{
    type: 'text';
    text: string;
  }>;
  model: string;
  stop_reason: 'end_turn' | 'max_tokens' | 'stop_sequence';
  usage: {
    input_tokens: number;
    output_tokens: number;
  };
}
```

### 7.2 TAVILY SEARCH API

#### Request Format
```typescript
interface TavilyRequest {
  api_key: string;
  query: string;
  search_depth?: 'basic' | 'advanced';
  max_results?: number;    // 1-20
  include_domains?: string[];
  exclude_domains?: string[];
  include_answer?: boolean;
  include_raw_content?: boolean;
}
```

#### Response Format
```typescript
interface TavilyResponse {
  answer?: string;         // AI summary
  results: Array<{
    title: string;
    url: string;
    content: string;       // Snippet
    raw_content?: string;  // Full text
    score: number;         // 0-1
    published_date?: string;
  }>;
  response_time: number;   // Milliseconds
}
```

### 7.3 FIRECRAWL API

#### Request Format
```typescript
interface FirecrawlRequest {
  url: string;
  formats?: ('markdown' | 'html' | 'links')[];
  excludeTags?: string[];
  includeTags?: string[];
  onlyMainContent?: boolean;
  waitFor?: number;        // Milliseconds
}
```

#### Response Format
```typescript
interface FirecrawlResponse {
  success: boolean;
  data: {
    markdown?: string;
    html?: string;
    links?: string[];
    metadata: {
      title?: string;
      description?: string;
      author?: string;
      publishedDate?: string;
      ogImage?: string;
    };
  };
}
```

---

## 8. CACHING & STORAGE SYSTEMS

### 8.1 BROWSER STORAGE

#### LocalStorage
- **Format**: String key-value pairs
- **Encoding**: JSON.stringify for objects
- **Namespace**: Prefixed keys (e.g., "wsw_*")
- **Capacity**: ~5-10MB per domain
- **Persistence**: Until explicitly cleared

#### SessionStorage
- **Format**: Same as LocalStorage
- **Lifecycle**: Per browser tab
- **Capacity**: ~5-10MB per tab
- **Use case**: Temporary UI state

#### Cookies
- **Format**: name=value; attribute1; attribute2
- **Attributes**:
  - Path=/ (accessible site-wide)
  - Domain (optional subdomain)
  - Expires or Max-Age
  - Secure (HTTPS only)
  - HttpOnly (no JavaScript access)
  - SameSite=Strict|Lax|None
- **Capacity**: ~4KB per cookie
- **Use case**: Authentication tokens

#### IndexedDB (Future)
- **Type**: NoSQL object store
- **Capacity**: Varies (100MB+)
- **Use case**: Offline data, large datasets

### 8.2 SERVER-SIDE CACHING

#### Next.js Cache
- **Location**: .next/cache/
- **Types**:
  - Data Cache (fetch responses)
  - Full Route Cache (HTML)
  - Router Cache (client-side navigation)
- **Format**: Binary (Next.js internal)

#### Redis (Future)
- **Type**: In-memory key-value store
- **Data structures**: Strings, hashes, lists, sets, sorted sets
- **TTL**: Per-key expiration
- **Use case**: Session storage, rate limiting

### 8.3 FILE STORAGE

#### Local Development
- **Uploads**: formidable temp directory
- **Exports**: /tmp or streaming downloads

#### Cloud Storage (Optional)

**AWS S3**:
- **Bucket structure**: /uploads/{type}/{year}/{month}/{filename}
- **Metadata**: Content-Type, custom metadata
- **Access**: Pre-signed URLs, public URLs

**Cloudinary**:
- **Upload**: Multipart form data
- **Response**: JSON with URLs
- **Transformations**: URL-based parameters

---

## 9. LOGGING & MONITORING FORMATS

### 9.1 APPLICATION LOGS

```typescript
interface LogEntry {
  timestamp: string;       // ISO 8601
  level: 'debug' | 'info' | 'warn' | 'error' | 'fatal';
  message: string;
  context?: string;        // Module name
  data?: Record<string, any>;
  userId?: string;
  requestId?: string;
  stack?: string;          // Error stack trace
  duration?: number;       // Request duration (ms)
}
```

### 9.2 AUDIT LOGS

```typescript
interface AuditLogEntry {
  id: string;
  action: AuditAction;
  actorType: 'USER' | 'API_KEY' | 'SYSTEM' | 'ANONYMOUS';
  actorId?: string;
  userId?: string;
  entityType?: string;
  entityId?: string;
  changes?: Array<{
    field: string;
    oldValue: any;
    newValue: any;
  }>;
  metadata?: Record<string, any>;
  ipAddress?: string;
  userAgent?: string;
  status: 'SUCCESS' | 'FAILURE';
  timestamp: Date;
}
```

### 9.3 SCRIPT EXECUTION LOGS

```typescript
interface ScriptLogEntry {
  id: string;
  scriptId: string;
  status: 'success' | 'error' | 'timeout';
  output?: string;
  error?: string;
  duration: number;        // Milliseconds
  executedAt: Date;
}
```

---

## 10. SEARCH & INDEXING

### 10.1 FULL-TEXT SEARCH

#### PostgreSQL tsvector Format
```sql
-- Internal representation
to_tsvector('english', 'The quick brown fox')
-- Result: 'brown':3 'fox':4 'quick':2

-- Query format
to_tsquery('english', 'quick & fox')
plainto_tsquery('english', 'quick fox')
websearch_to_tsquery('english', '"quick fox"')
```

#### Search Query Structure
```typescript
interface SearchQuery {
  q: string;               // Search term
  type?: Array<'case' | 'person' | 'organization' | 'statement'>;
  filters?: {
    dateFrom?: string;
    dateTo?: string;
    status?: string[];
    [key: string]: any;
  };
  limit?: number;
  offset?: number;
}
```

#### Search Result Structure
```typescript
interface SearchResult {
  id: string;
  type: 'case' | 'person' | 'organization' | 'statement';
  title: string;
  snippet: string;         // Highlighted excerpt
  url: string;
  score: number;           // Relevance 0-1
  metadata?: Record<string, any>;
}
```

### 10.2 AUTOCOMPLETE

#### Request Format
```typescript
interface AutocompleteQuery {
  q: string;               // Min 2 chars
  type?: string[];
  limit?: number;          // Default 10, max 50
}
```

#### Response Format
```typescript
interface AutocompleteSuggestion {
  value: string;
  label: string;
  type: string;
  id: string;
  meta?: Record<string, any>;
}
```

---

## 11. WEBHOOK & EVENT SYSTEMS

### 11.1 OUTGOING WEBHOOKS

#### Event Types
```typescript
type WebhookEvent =
  | 'case.created'
  | 'case.updated'
  | 'case.deleted'
  | 'case.promoted'
  | 'person.created'
  | 'person.updated'
  | 'statement.created'
  | 'statement.verified';
```

#### Payload Format
```typescript
interface WebhookPayload {
  event: WebhookEvent;
  id: string;
  timestamp: string;       // ISO 8601
  data: {
    id: string;
    type: string;
    action: 'created' | 'updated' | 'deleted';
    before?: Record<string, any>;
    after: Record<string, any>;
  };
  metadata?: Record<string, any>;
}
```

#### Security Headers
```
X-Webhook-Signature: sha256=<hmac_hex>
X-Webhook-ID: <unique_id>
X-Webhook-Timestamp: <iso8601>
```

---

## 12. IMPORT/EXPORT SCHEMAS

### 12.1 CSV IMPORT

#### Person CSV
```csv
slug,name,profession,nationality,bio,birthDate,deathDate
john-doe,John Doe,JOURNALIST,USA,"Biography text",1980-01-01,
```

#### Case CSV
```csv
slug,title,summary,caseDate,status,severity
case-1,Title,Summary,2024-01-15,DOCUMENTED,MEDIUM
```

### 12.2 MARKDOWN IMPORT

#### Frontmatter (YAML)
```yaml
---
slug: example-case
title: Case Title
date: 2024-01-15
status: documented
tags: [tag1, tag2, tag3]
---
```

#### Body (Markdown)
```markdown
## Person Name
- **Profession:** Their role
- **Date:** Date of case
- **Exact Wording:** *"The exact quote"*
- **Context:** Background
- **Citations:** [Source](url)
```

### 12.3 JSON EXPORT

```json
{
  "version": "1.0",
  "exportDate": "2025-01-26T12:00:00Z",
  "type": "person",
  "data": [
    {
      "id": "...",
      "slug": "...",
      "name": "...",
      "affiliations": [],
      "statements": []
    }
  ],
  "meta": {
    "total": 100,
    "exported": 100
  }
}
```

---

## 13. IDENTIFIER & ENCODING FORMATS

### 13.1 PRIMARY KEY FORMATS

#### CUID
- **Format**: c + timestamp + counter + random
- **Length**: 25 characters
- **Pattern**: ^c[a-z0-9]{24}$
- **Example**: ckl3q4j5k0000qzrmn1b9ux7a
- **Collision**: Resistant

#### UUID (Apps Module)
- **Version**: UUID v4 (random)
- **Format**: 8-4-4-4-12 hex digits
- **Example**: 550e8400-e29b-41d4-a716-446655440000

### 13.2 SLUG FORMAT
- **Pattern**: ^[a-z0-9-]+$
- **Max Length**: 200 characters
- **Generation**: lowercase + hyphens
- **Uniqueness**: Database-enforced

### 13.3 COUNTRY CODES
- **ISO 3166-1 alpha-2**: Two letters (US, UK, FR)
- **ISO 3166-1 alpha-3**: Three letters (USA, GBR, FRA)
- **ISO 3166-1 numeric**: Numbers (840, 826, 250)

### 13.4 CHARACTER ENCODINGS
- **Primary**: UTF-8 (Unicode)
- **Fallback**: ASCII (subset)
- **Database**: UTF-8
- **API**: UTF-8
- **Files**: UTF-8

### 13.5 URL ENCODING
- **Percent Encoding**: %XX for special chars
- **Spaces**: %20 or + (in query strings)
- **Reserved**: ! * ' ( ) ; : @ & = + $ , / ? # [ ]

---

## 14. TIME & DATE FORMATS

### 14.1 ISO 8601 STANDARD
- **Date**: YYYY-MM-DD
- **Time**: HH:mm:ss.sss
- **DateTime**: YYYY-MM-DDTHH:mm:ss.sssZ
- **Timezone**: Z (UTC) or ±HH:mm

### 14.2 DATABASE FORMATS
- **PostgreSQL**: TIMESTAMPTZ (with timezone)
- **Prisma**: JavaScript Date object
- **Storage**: UTC timezone

### 14.3 DISPLAY FORMATS
- **Relative**: "2 hours ago" (date-fns)
- **Absolute**: "January 26, 2025"
- **Short**: "Jan 26, 2025"
- **Technical**: ISO 8601

---

## 15. MIME TYPES & CONTENT TYPES

### 15.1 TEXT TYPES
- `text/plain` - Plain text
- `text/html` - HTML documents
- `text/css` - Stylesheets
- `text/javascript` - JavaScript
- `text/csv` - CSV data
- `text/markdown` - Markdown

### 15.2 APPLICATION TYPES
- `application/json` - JSON (primary API)
- `application/xml` - XML documents
- `application/pdf` - PDF files
- `application/octet-stream` - Binary
- `application/x-www-form-urlencoded` - Forms
- `multipart/form-data` - File uploads

### 15.3 IMAGE TYPES
- `image/jpeg` - JPEG
- `image/png` - PNG
- `image/webp` - WebP
- `image/avif` - AVIF
- `image/svg+xml` - SVG
- `image/gif` - GIF

---

## 16. HTTP STATUS CODES

### 16.1 SUCCESS (2xx)
- **200 OK** - Standard success
- **201 Created** - Resource created
- **204 No Content** - Success, no body

### 16.2 REDIRECTION (3xx)
- **301 Moved Permanently**
- **302 Found** (temporary)
- **304 Not Modified** (cache valid)

### 16.3 CLIENT ERRORS (4xx)
- **400 Bad Request** - Invalid syntax
- **401 Unauthorized** - Auth required
- **403 Forbidden** - Access denied
- **404 Not Found** - Resource missing
- **422 Unprocessable Entity** - Validation failed
- **429 Too Many Requests** - Rate limit

### 16.4 SERVER ERRORS (5xx)
- **500 Internal Server Error**
- **502 Bad Gateway**
- **503 Service Unavailable**

---

## 17. SECURITY FORMATS

### 17.1 JWT FORMAT
```
header.payload.signature

Header:  {"alg":"RS256","typ":"JWT"}
Payload: {"sub":"user_id","exp":1234567890}
Signature: base64(sign(header + payload))
```

### 17.2 PASSWORD HASH
```
$2a$10$N9qo8uLO...

Format: $2a$[cost]$[salt][hash]
Algorithm: bcrypt
Cost: 10 (2^10 iterations)
```

### 17.3 API KEY FORMAT
```
wsw_live_AbCdEf123456789...

Prefix: wsw_[environment]_
Length: 32+ random characters
Storage: SHA-256 hashed
```

### 17.4 WEBHOOK SIGNATURE
```
sha256=abc123def456...

Algorithm: HMAC-SHA256
Header: X-Webhook-Signature
Verification: Compare computed vs provided
```

---

## COMPREHENSIVE FORMAT SUMMARY

### Input Formats
✓ Markdown (.md) - YAML + CommonMark
✓ CSV (.csv) - UTF-8, comma-delimited
✓ JSON (.json) - RFC 8259
✓ Form Data - multipart/form-data
✓ Images - JPEG, PNG, WebP, AVIF, SVG

### Output Formats
✓ JSON - Standardized API responses
✓ HTML5 - Semantic markup
✓ XML - Sitemaps
✓ CSV - Data exports
✓ Optimized Images - AVIF/WebP

### Protocols
✓ HTTP/HTTPS - Client-server
✓ PostgreSQL Protocol - Database
✓ WebSocket - Real-time (future)
✓ TLS 1.2+ - Encryption

### Standards
✓ ISO 8601 - Date/time
✓ ISO 3166-1 - Country codes
✓ RFC 8259 - JSON
✓ RFC 7519 - JWT
✓ CommonMark - Markdown
✓ UTF-8 - Character encoding

### Type Systems
✓ TypeScript - Static typing
✓ Prisma Schema - Database types
✓ 170+ Enums - Classifications
✓ JSON Schema - Validation

This document provides complete coverage of all formats, types, systems, stacks, and connections in the Who-Said-What project.
